# Chapter 4 Machine Languaged

>Make everything as simple as possible , but not simpler.   
>让每件事尽可能简单，而又不简单过度
    
*   Introduction
    
    *   计算机的描述：结构化
        
    *   图灵：固定硬件通过加载软件来完成功能
        
    *   机器语言是一种约定的形式，用来对底层程序进行编码，从而形成机器指令
        
        *   可以直接运行在指定的硬件平台上
            
        
    *   是硬件与软件相接的中间线
        
    *   Hack机器语言包括二进制版本与符号汇编版本
        
    
*   Background
    
    *   为了对机器语言做一般性描述，只需要集中讨论三个主要的抽象体：处理器，内存，寄存器
        
    *   机器
        
        *   机器语言是一种约定的形式，利用处理器与寄存器来操控内存
            
        *   内存：用来储存数据和指令的硬件设备
            
            *   发展：出现的问题
                
                *   大内存的地址需要大量字节
                    
                *   在内存中寻找一个元素变得缓慢
                    
                
            *   最基本解决方案：内存层次结构（memory hierarchy）
                
                *   结构：寄存器——cache缓存——main memory——
                    
                *   不同级别的处理方式不同
                    
                *   寄存器
                    
                    *   通常存在于cpu内侧，有少量的寄存器
                        
                    *   类型与功能其实是机器语言的一部分
                        
                    *   所以从这里获取信息无延迟的
                        
                    *   Data register
                        
                        *   可以对少量的内存进行大量的操作
                            
                        
                    *   Address register
                        
                        *   允许指定更大区域的具体部分
                            
                        
                    
                
            
        
    *   语言
        
        *   一系列编码指令
            
        *   基础为二进制码，可以运行在硬件平台上（101000011010）
            
        *   通常会采用助记符，如1010=add，用字母表示寄存器...（Add R3.R1.R9)
            
        
    *   命令
        
        *   算术操作与逻辑操作
            
        *   内存访问
            
            *   算术&逻辑命令可能会操控寄存器&内存
                
            *   计算机会使用load与store命令在寄存器和内存中传递数据
                
            *   如何确定内存的位置？——寻址方式
                
                *   Register：
                    
                    *   直接对cpu内部的寄存器处理
                        
                    
                *   Direct：直接寻址：
                    
                    *   直接表示内存单元的地址（或用符号表示）
                        
                    
                *   Indirect：间接寻址：
                    
                    *   内存单元的地址不直接出现在指令中，而由指令指定的内存单元中的内容代表目标内容的地址
                        
                    *   类似于指针pointer，数组
                        
                        *   高级语言的数组被声明，初始化时，编译器会分配一组连续的内存单元来保存数组，同时用符号来指代基地址（base address）
                            
                        *   此后，地址解析时利用偏移量计算相关地址
                            
                        
                    
                *   Immediate：立即寻址
                    
                    *   通常用来加载常数（加载在指令代码内部的数值）
                        
                    *   即指令中存在数字，与内存单元无关
                        
                    
                
            
        *   控制流（flow control）：如何告诉硬件下一步执行什么指令？
            
            *   反复（repetition）：跳回到程序的初始位置
                
            *   有条件执行：如if，then
                
            *   子程序调用；跳转到另一个指令段的第一条命令出
                
            *   无条件跳转：jump到xx指令，通常用于循环
                
            
        
    
*   Specifiction
    
    *   Hack computer：
        
        *   基于冯诺依曼架构的16-bit的计算机（以16位为数据原子）
            
        *   硬件平台：
            
            *   （RAM）Data memory：数据内存：每一个值存储在一个内存寄存器中
                
            *   （ROM）Instruction memory：指令内存：相对独立
                
            *   （CPU）Central Processing Unit：通过内部的ALU来进行16位计算
                
            *   buses：总线：用来传输数据
                
            *   内存映射I/O设备：显示器，键盘
                
            
        *   软件：
            
            *   由机器语言组成：
                
                *   A指令
                    
                *   C指令
                    
                
            *   Hack program本质上是一个指令序列
                
            *   每一个涉及内存地址的操作都需要2个Hack命令，一个确定地址（A），一个确定操作（C）
                
            *   确定地址后，M即代表指代的寄存器
                
            
        *   Control
            
            *   HC内置有reset按钮
                
            *   将指令导入ROM，reset，系统开始运行
                
            
        *   寄存器
            
            *   D寄存器：仅用来存储数据值
                
            *   A寄存器：数据&地址
                
                *   由于地址较长，无法将操作与地址置于同一个指令中，所以需要A来充当指针
                    
                *   A也用来对ROM直接访问，Hack的jump不指定特定地址，而是跳转到A寄存器指定的指令
                    
                
            *   M寄存器：内存中被选入的寄存器
                
            
        
    *   A指令（Addressing）
        
        *   @ value：value需要为一个非负的十进制数
            
        *   这个指令会将特定的值储存到A寄存器中
            
        *   用途
            
            *   唯一一种将常数输入计算机中的方法
                
            *   将目标数据单元的地址放入A，为为进行操作的C提供条件
                
            *   或是存入跳转的目的地址，为执行跳转的C提供条件
                
            
        
    *   C指令
        
        *   dest = comp ; jump
            
        *   指令代码的描述：计算什么？存储到哪？下一步做什么？
            
        *   Computation：计算规范
            
            *   ALU执行固定的函数集合
                
            *   1个a位域，6个c位域，通过7位对128个不同函数进行编码，规范中只列出了28个(右边打错了，是a=1）
                
                *   ![](https://api2.mubu.com/v3/document_image/a6a30624-0df6-4e78-a837-1371e3e29402-14191769.jpg)
            
        *   Destination：目的地规范
            
            *   comp部分计算出来的值能够被存储在不同的目的地址单元
                
            *   通过3位dest域描述
                
                *   1，2决定是否存入A,D
                    
                *   3决定是否存入M
                    
                    *   ![](https://api2.mubu.com/v3/document_image/37b15567-ca50-40c7-8d22-e20fc6f1f1f5-14191769.jpg)
                
            
        *   Jump：跳转规范
            
            *   jump通知计算机下一步将执行什么命令
                
                *   默认情况将执行下一条指令
                    
                *   获取其他地址的一条指令（A寄存器会记录这个地址）
                    
                
            *   jump的比较规范都是相对于0而言
                
                *   ![](https://api2.mubu.com/v3/document_image/1aefbbd9-678e-4a0c-a42e-2d70da3b9823-14191769.jpg)
            
        *   A寄存器的冲突
            
            *   ![](https://api2.mubu.com/v3/document_image/cfe6da16-ee10-4703-9cbf-fbaa7c1887f5-14191769.jpg)
        
    *   Hack程序
        
        *   一个hack程序是一系列hack指令
            
        *   运行时将助记符转化为二进制码，由硬件平台运行
            
        
    *   符号
        
    *   输入/输出
        
        *   Hack平台可以连接两个外部设备，交互通过内存映像来实现
            
            *   内存映像：物理IO设备与对应内存通过循环刷新同步
                
            *   16-bit
                
            
        *   屏幕
            
            *   屏幕内容由内存映像表示（RAM中）
                
                *   计算公式
                    
                *   RAM\[16394+r\*32+c/16\]+c%16：每一行由32个连续的16位字表示，r行c列
                    
                *   每次操作的原子单位是16-bit的一个word
                    
                
            *   读写对应位置（内存基本操作）
                
                *   @ xxx：将A寄存器位置映射到屏幕第一行的16个最左边的像素
                    
                *   M+1=1：第2个像素变黑
                    
                
            
        *   键盘
            
            *   Hack计算机与物理键盘通过单字内存映像交互
                
            *   键盘上敲击时，对应的ASCII码出现在该内存，无敲击时，为0
                
            
        
    *   语法规约/文件格式
        
        *   二进制文件：
            
            *   .hack拓展名，直接加载到硬件平台中
                
            
        *   汇编语言文件：
            
            *   .asm拓展名，文本文件
                
            *   指令：A/C
                
            *   符号
                
                *   常数，符号
                    
                *   注释
                    
                *   空格
                    
                *   大小写
                    
                
            
        
    
*   Perspective
    
*   Hack programing
    
    *   内存处理
        
        *   DAM寄存器
            
            *   A寄存器，加载特定值后会从RAM中选择特定寄存器M
                
            *   利用A，C指令
                
            
        *   虚拟寄存器：R1=1，目的只是使程序更易于阅读
            
        
    *   变量：variable
        
        *   只有一种数据类型：16bit
            
        *   @ temp代表声明变量，在接下来的指令中用M来寻址，这个变量会被分配到一个未使用的内存去
            
        
    *   分支：Branching
        
        *   评估布尔逻辑，决定是否转移程序执行
            
        *   Jump部分的语法
            
        *   分支的跳转到xx行可读性差，汇编程序允许符号Label来进行跳转，汇编器会进行自动翻译（替换了标签的引用）
            
        
    *   迭代：Iterative
        
        *   通过合理的jump可以实现循环和迭代，伪代码
            
        
    *   指针
        
        *   存储内存地址的变量叫做指针
            
        
    *   输入输出
        
    
*   Project
    
    *   机器语言顶层编程
        
    *   tool：汇编编译器，CPU仿真器
        
        *   CPU仿真器将汇编程序翻译为二进制代码，加载到硬件平台
            
        
    *   乘法程序
        
    *   I/O处理程序
        
    